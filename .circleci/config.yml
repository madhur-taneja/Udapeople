version: 2.1
orbs:
    node: circleci/node@1.1.6
jobs:
    # Creating Infrastructure
    creating-infrastructure:
        docker:
            - image: amazon/aws-cli
        steps:
            - checkout
            - run:
                name: Ensure backend infrastructure exist
                command: |
                    aws cloudformation create-stack \
                        --template-body file://.circleci/files/backend.yml \
                        --stack-name udapeople-stack \
                        --parameters ParameterKey=ID,ParameterValue=${CIRCLE_WORKFLOW_ID:0:7}

    # Analyzing Code
    analyzing-backend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd backend && npm i && npm audit fix --audit-level=critical --force
    analyzing-frontend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd frontend && npm i && npm audit fix --audit-level=critical --force
    
    # Testing Code
    testing-frontend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd frontend && npm i && npm run test

    testing-backend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd backend && npm i && npm run test

    # Building Code
    building-frontend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd frontend && npm i && npm run build 

    building-backend:
        executor:
            name: node/default
        steps:
            - checkout
            - run: cd backend && npm i && npm run build
      
workflows:
    analyzing-testing-building-deploying:
        jobs:
            # Running Analysis Jobs
            - analyzing-backend
            - analyzing-frontend
            
            # Running Test Jobs
            - testing-frontend:
                requires:
                    - analyzing-frontend
            - testing-backend:
                requires:
                    - analyzing-backend
              
            # Running Build Jobs
            - building-backend:
                requires:
                    - testing-backend
            - building-frontend:
                requires:
                    - testing-frontend
                    - building-backend
            # Running Infrastructure Jobs
            - creating-infrastructure
            